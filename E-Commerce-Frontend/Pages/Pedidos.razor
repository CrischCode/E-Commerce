@page "/pedidos"
@using Ecommerce.Shared.DTOs
@using E_Commerce_Frontend.Interfaces
@inject IPedidos PedidoService
@inject IJSRuntime JS

<div class="container-fluid mt-4 px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">Gestión de Pedidos</h2>
            <p class="text-muted small">Panel administrativo de ventas e inventario</p>
        </div>
        <div class="d-flex gap-2">
            
            <button class="btn btn-primary shadow-sm px-4 py-2 fw-bold d-flex align-items-center gap-2" 
                    style="border-radius: 10px; background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%); border: none;"
                    @onclick="AbrirModalCrear">
                <i class="bi bi-plus-lg"></i> Nuevo Pedido
            </button>
            
            @* BUSCADOR CORREGIDO: Ahora vinculado a idPedidoFiltro *@
            <div class="input-group shadow-sm" style="width: 250px;">
                <span class="input-group-text bg-white border-0"><i class="bi bi-search text-muted"></i></span>
                <input type="number" class="form-control border-0" placeholder="Buscar ID Pedido..." 
                       @bind="idPedidoFiltro" @bind:event="oninput" @onkeyup="ConsultarBusqueda" />
            </div>

            <select class="form-select border-0 shadow-sm custom-select-filter" 
                    @onchange="FiltrarEstado" 
                    style="border-radius: 10px; width: 200px; background-color: #f8f9fa; padding: 10px 15px; font-size: 0.9rem; font-weight: 600; color: #495057;">
                <option value="" selected>Todos los estados</option>
                <option value="Pendiente">Pendiente</option>
                <option value="En Proceso">En Proceso</option>
                <option value="Completado">Completado</option>
                <option value="Cancelado">Cancelado</option>
            </select>
        </div>
    </div>

    <div class="card border-0 shadow-sm" style="border-radius: 15px; overflow: hidden;">
        <div class="card-body p-0">
            @if (pedidos == null)
            {
                <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 py-3 text-muted fw-bold small">ID PEDIDO</th>
                                <th class="py-3 text-muted fw-bold small">CLIENTE</th>
                                <th class="py-3 text-muted fw-bold small">FECHA</th>
                                <th class="py-3 text-muted fw-bold small">TOTAL</th>
                                <th class="py-3 text-muted fw-bold small">ESTADO</th>
                                <th class="text-end pe-4 py-3 text-muted fw-bold small">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ped in pedidos)
                            {
                                <tr>
                                    <td class="ps-4 fw-bold text-primary">#@ped.IdPedido</td>
                                    <td>
                                        <div class="fw-bold">@ped.Cliente</div>
                                        <div class="text-muted x-small">ID Cliente: @ped.IdCliente</div>
                                    </td>
                                    <td>@ped.FechaPedido.ToString("dd MMM yyyy")</td>
                                    <td><span class="fw-bold text-dark">@ped.Total.ToString("C")</span></td>
                                    <td>
                                        <span class="badge rounded-pill px-3 py-2 @GetStatusClass(ped.Estado)">
                                            @ped.Estado
                                        </span>
                                    </td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-action btn-view me-2" @onclick="() => VerDetalles(ped.IdPedido)">
                                            <i class="bi bi-eye-fill me-1"></i> Ver
                                        </button>

                                        @if (ped.Estado == "Pendiente")
                                        {
                                            <button class="btn btn-action btn-edit me-2" @onclick='() => ActualizarEstado(ped.IdPedido, "En Proceso")'>
                                                <i class="bi bi-gear-fill me-1"></i> Procesar
                                            </button>
                                            <button class="btn btn-action btn-delete" @onclick="() => Eliminar(ped.IdPedido)">
                                                <i class="bi bi-trash3-fill me-1"></i> Eliminar
                                            </button>
                                        }
                                        @if (ped.Estado == "En Proceso")
                                        {
                                            <button class="btn btn-action btn-success-custom ms-1" @onclick='() => ActualizarEstado(ped.IdPedido, "Completado")'>
                                                <i class="bi bi-check-circle-fill me-1"></i> Completar
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-between align-items-center p-4 bg-light border-top">
                    <span class="small text-muted">Mostrando página <strong>@paginaActual</strong> de @totalItems registros</span>
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item @(paginaActual == 1 ? "disabled" : "")">
                                <button class="btn btn-sm btn-light border rounded-pill px-3 me-2" @onclick="() => IrAPagina(paginaActual - 1)">Anterior</button>
                            </li>
                            <li class="page-item">
                                <button class="btn btn-sm btn-primary rounded-pill px-3 @(pedidos.Count < pageSize && totalItems <= paginaActual * pageSize ? "disabled" : "")" @onclick="() => IrAPagina(paginaActual + 1)">Siguiente</button>
                            </li>
                        </ul>
                    </nav>
                </div>
            }
        </div>
    </div>
</div>

@* MODALES *@
@if (mostrarModalCrear)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1060;">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow" style="border-radius: 20px;">
                <div class="modal-header border-0 p-4 pb-0">
                    <h5 class="fw-bold"><i class="bi bi-cart-plus text-primary"></i> Nueva Orden de Venta</h5>
                    <button type="button" class="btn-close" @onclick="() => mostrarModalCrear = false"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-3 mb-4 bg-light p-3 rounded-4">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">ID Cliente</label>
                            <input type="number" class="form-control border-0 shadow-sm" style="border-radius: 10px;" @bind="nuevoPedido.IdCliente" placeholder="Ingrese ID del cliente" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Método de Pago</label>
                            <select class="form-select border-0 shadow-sm" style="border-radius: 10px;" @bind="nuevoPedido.IdMetodoPago">
                                <option value="0">-- Seleccione --</option>
                                <option value="1">Efectivo</option>
                                <option value="2">Tarjeta de Crédito</option>
                                <option value="3">Transferencia</option>
                            </select>
                        </div>
                    </div>

                    <h6 class="fw-bold mb-3 small text-uppercase text-muted">Productos del Pedido</h6>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead class="text-muted small">
                                <tr>
                                    <th style="width: 60%">Producto (ID)</th>
                                    <th style="width: 30%">Cantidad</th>
                                    <th style="width: 10%"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var det in nuevoPedido.Detalles)
                                {
                                    <tr>
                                        <td><input type="number" class="form-control form-control-sm border-0 bg-light" @bind="det.IdProducto" placeholder="ID Prod" /></td>
                                        <td><input type="number" class="form-control form-control-sm border-0 bg-light" @bind="det.Cantidad" /></td>
                                        <td class="text-center">
                                            <button class="btn btn-link btn-sm text-danger" @onclick="() => nuevoPedido.Detalles.Remove(det)">
                                                <i class="bi bi-dash-circle-fill"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-outline-primary btn-sm rounded-pill mt-2" @onclick="() => nuevoPedido.Detalles.Add(new())">
                        <i class="bi bi-plus-circle"></i> Agregar Fila
                    </button>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button class="btn btn-light px-4 fw-bold" style="border-radius: 10px;" @onclick="() => mostrarModalCrear = false">Cancelar</button>
                    <button class="btn btn-primary px-4 fw-bold shadow-sm" style="border-radius: 10px;" @onclick="GuardarPedido">Generar Pedido</button>
                </div>
            </div>
        </div>
    </div>
}

@if (pedidoSeleccionado != null)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1050;">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow" style="border-radius: 20px;">
                <div class="modal-header border-0 p-4">
                    <h5 class="fw-bold">Detalle del Pedido #@pedidoSeleccionado.IdPedido</h5>
                    <button type="button" class="btn-close" @onclick="() => pedidoSeleccionado = null"></button>
                </div>
                <div class="modal-body p-4 pt-0">
                    <div class="row mb-4 bg-light p-3 rounded-4">
                        <div class="col-md-6 small">
                            <strong>Cliente:</strong> @pedidoSeleccionado.Cliente <br/>
                            <strong>Fecha:</strong> @pedidoSeleccionado.FechaPedido
                        </div>
                        <div class="col-md-6 text-md-end small">
                            <strong>Método Pago:</strong> @pedidoSeleccionado.MetodoPago <br/>
                            <strong>Estado Actual:</strong> <span class="badge @GetStatusClass(pedidoSeleccionado.Estado)">@pedidoSeleccionado.Estado</span>
                        </div>
                    </div>
                    
                    <table class="table table-sm align-middle">
                        <thead class="text-muted small">
                            <tr>
                                <th>Producto</th>
                                <th class="text-center">Cant.</th>
                                <th class="text-end">Precio</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var det in pedidoSeleccionado.Detalles)
                            {
                                <tr>
                                    <td>@det.NombreProducto</td>
                                    <td class="text-center">@det.Cantidad</td>
                                    <td class="text-end">@det.PrecioUnitario.ToString("C")</td>
                                    <td class="text-end fw-bold">@det.SubTotal.ToString("C")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="border-top">
                                <td colspan="3" class="text-end fw-bold pt-3">TOTAL:</td>
                                <td class="text-end fw-bold pt-3 text-primary fs-5">@pedidoSeleccionado.Total.ToString("C")</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .x-small { font-size: 0.75rem; }
    .status-pendiente { background-color: #fff3cd; color: #856404; }
    .status-proceso { background-color: #cfe2ff; color: #084298; }
    .status-completado { background-color: #d1e7dd; color: #0f5132; }
    .status-cancelado { background-color: #f8d7da; color: #842029; }

    .btn-action {
        padding: 6px 14px; border-radius: 8px; border: none; font-size: 0.85rem; font-weight: 600;
        transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center;
    }
    .btn-view { background-color: #e7f1ff; color: #0d6efd; }
    .btn-view:hover { background-color: #0d6efd; color: #fff; transform: translateY(-2px); }
    .btn-edit { background-color: #fff3cd; color: #856404; }
    .btn-edit:hover { background-color: #ffc107; color: #fff; transform: translateY(-2px); }
    .btn-delete { background-color: #f8d7da; color: #721c24; }
    .btn-delete:hover { background-color: #dc3545; color: #fff; transform: translateY(-2px); }
    .btn-success-custom { background-color: #d1e7dd; color: #0f5132; }
    .btn-success-custom:hover { background-color: #198754; color: #fff; transform: translateY(-2px); }
</style>

@code {
    private List<PedidoReadDto>? pedidos;
    private PedidoReadDto? pedidoSeleccionado;
    private PedidoCreateDto nuevoPedido = new() { Detalles = new() };
    private bool mostrarModalCrear = false;
    private string? estadoFiltro;
    
    // CORRECCIÓN: Variable de búsqueda renombrada para mayor claridad
    private int? idPedidoFiltro; 
    
    private int paginaActual = 1;
    private int pageSize = 10;
    private int totalItems = 0;

    protected override async Task OnInitializedAsync() => await Cargar();

    private async Task Cargar()
    {
        // Se envía idPedidoFiltro al backend
        var response = await PedidoService.GetPagedAsync(paginaActual, pageSize, estadoFiltro, idPedidoFiltro);
        pedidos = response.Date;
        totalItems = response.Total;
    }

    private async Task ConsultarBusqueda(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || idPedidoFiltro == null) 
        {
            paginaActual = 1;
            await Cargar();
        }
    }

    private async Task IrAPagina(int nuevaPagina)
    {
        paginaActual = nuevaPagina;
        await Cargar();
    }

    private async Task ActualizarEstado(int id, string nuevoEstado)
    {
        try {
            var dto = new PedidoUpdateDto { Estado = nuevoEstado };
            if (await PedidoService.UpdateAsync(id, dto)) await Cargar();
        } catch (Exception ex) {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            await Cargar();
        }
    }

    private void AbrirModalCrear()
    {
        nuevoPedido = new() { Detalles = new List<DetallePedidoCreateDto> { new() } };
        mostrarModalCrear = true;
    }

    private async Task GuardarPedido()
    {
        if (nuevoPedido.IdCliente <= 0 || !nuevoPedido.Detalles.Any())
        {
            await JS.InvokeVoidAsync("alert", "Debe asignar un cliente y al menos un producto.");
            return;
        }

        if (await PedidoService.CreateAsync(nuevoPedido))
        {
            mostrarModalCrear = false;
            await Cargar();
        }
    }

    private async Task Eliminar(int id)
    {
        if (await JS.InvokeAsync<bool>("confirm", "¿Está seguro de eliminar este pedido pendiente?"))
        {
            await PedidoService.DeleteAsync(id);
            await Cargar();
        }
    }

    private async Task VerDetalles(int id) => pedidoSeleccionado = await PedidoService.GetByIdAsync(id);

    private async Task FiltrarEstado(ChangeEventArgs e)
    {
        estadoFiltro = e.Value?.ToString();
        paginaActual = 1;
        await Cargar();
    }

    private string GetStatusClass(string? estado) => estado switch
    {
        "Pendiente" => "status-pendiente",
        "En Proceso" => "status-proceso",
        "Completado" => "status-completado",
        "Cancelado" => "status-cancelado",
        _ => "bg-secondary text-white"
    };
}